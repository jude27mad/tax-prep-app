{% extends "base.html" %}
{% block head %}
  <style>
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem 1rem;
      margin-bottom: 1rem;
    }
    label.field {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    label.field span {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    textarea {
      border: 1px solid #cbd5f5;
      border-radius: 0.4rem;
      padding: 0.45rem 0.5rem;
      font-size: 0.95rem;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .section-heading {
      margin-top: 1.25rem;
      margin-bottom: 0.5rem;
      font-size: 1.05rem;
      font-weight: 600;
    }
    .field-error {
      color: #b91c1c;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
    .status-box {
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #cbd5f5;
      background: #eff6ff;
      margin-bottom: 0.75rem;
    }
    .status-box.success {
      border-color: #16a34a;
      background: #dcfce7;
      color: #166534;
    }
    .status-box.warning {
      border-color: #f97316;
      background: #fff7ed;
      color: #9a3412;
    }
    .status-box.error {
      border-color: #ef4444;
      background: #fee2e2;
      color: #b91c1c;
    }
    .slip-wrapper {
      border: 1px solid #e5e7eb;
      border-radius: 0.6rem;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #f9fafb;
    }
    .slip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .slip-header h4 {
      margin: 0;
      font-size: 1rem;
    }
    .actions-row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .status-note {
      font-size: 0.85rem;
      align-self: center;
      color: #9a3412;
    }
    .status-note.warning {
      font-weight: 600;
    }
    .btn[disabled] {
      cursor: not-allowed;
      opacity: 0.6;
    }
    .field-help {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #4b5563;
    }
    .artifact-list {
      margin-top: 0.5rem;
      padding-left: 1.2rem;
    }
    .artifact-list li {
      margin-bottom: 0.35rem;
    }
    pre {
      background: #0f172a;
      color: #f1f5f9;
      padding: 0.75rem;
      border-radius: 0.6rem;
      overflow-x: auto;
      font-size: 0.85rem;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="card">
    <h2>Return input</h2>
    {% if messages %}
      <ul class="messages">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    {% if field_errors %}
      <div class="status-box warning">Some fields need attention. Fix them and try again.</div>
    {% endif %}
    <form id="return-form" method="post" action="/ui/returns/prepare">
      <section>
        <div class="section-heading">Taxpayer details</div>
        <div class="form-grid">
          <label class="field">
            <span>SIN *</span>
            <input name="taxpayer_sin" value="{{ form_state.taxpayer.sin }}" required />
            {% if field_errors.get('taxpayer_sin') %}
              <div class="field-error">{{ field_errors.get('taxpayer_sin') }}</div>
            {% endif %}
          </label>
          <label class="field">
            <span>First name *</span>
            <input name="taxpayer_first_name" value="{{ form_state.taxpayer.first_name }}" required />
            {% if field_errors.get('taxpayer_first_name') %}
              <div class="field-error">{{ field_errors.get('taxpayer_first_name') }}</div>
            {% endif %}
          </label>
          <label class="field">
            <span>Last name *</span>
            <input name="taxpayer_last_name" value="{{ form_state.taxpayer.last_name }}" required />
            {% if field_errors.get('taxpayer_last_name') %}
              <div class="field-error">{{ field_errors.get('taxpayer_last_name') }}</div>
            {% endif %}
          </label>
          <label class="field">
            <span>Date of birth *</span>
            <input type="date" name="taxpayer_dob" value="{{ form_state.taxpayer.dob }}" required />
            {% if field_errors.get('taxpayer_dob') %}
              <div class="field-error">{{ field_errors.get('taxpayer_dob') }}</div>
            {% endif %}
          </label>
          <label class="field">
            <span>Address line 1 *</span>
            <input name="taxpayer_address_line1" value="{{ form_state.taxpayer.address_line1 }}" required />
            {% if field_errors.get('taxpayer_address_line1') %}
              <div class="field-error">{{ field_errors.get('taxpayer_address_line1') }}</div>
            {% endif %}
          </label>
          <label class="field">
            <span>City *</span>
            <input name="taxpayer_city" value="{{ form_state.taxpayer.city }}" required />
            {% if field_errors.get('taxpayer_city') %}
              <div class="field-error">{{ field_errors.get('taxpayer_city') }}</div>
            {% endif %}
          </label>
          <label class="field">
            <span>Province *</span>
            <input name="taxpayer_province" maxlength="2" value="{{ form_state.taxpayer.province }}" required />
            {% if field_errors.get('taxpayer_province') %}
              <div class="field-error">{{ field_errors.get('taxpayer_province') }}</div>
            {% endif %}
          </label>
          <label class="field">
            <span>Postal code *</span>
            <input name="taxpayer_postal_code" value="{{ form_state.taxpayer.postal_code }}" required />
            {% if field_errors.get('taxpayer_postal_code') %}
              <div class="field-error">{{ field_errors.get('taxpayer_postal_code') }}</div>
            {% endif %}
          </label>
          <label class="field">
            <span>Residency status</span>
            <input name="taxpayer_residency_status" value="{{ form_state.taxpayer.residency_status }}" />
          </label>
        </div>
      </section>

      <section>
        <div class="section-heading">Household</div>
        <div class="form-grid">
          <label class="field">
            <span>Marital status</span>
            <input name="household_marital_status" value="{{ form_state.household.marital_status }}" />
          </label>
          <label class="field">
            <span>Spouse SIN</span>
            <input name="household_spouse_sin" value="{{ form_state.household.spouse_sin }}" />
            {% if field_errors.get('household_spouse_sin') %}
              <div class="field-error">{{ field_errors.get('household_spouse_sin') }}</div>
            {% endif %}
          </label>
          <label class="field" style="grid-column: 1 / -1;">
            <span>Dependants (one per line)</span>
            <textarea name="household_dependants_raw">{{ form_state.household.dependants_raw }}</textarea>
          </label>
        </div>
      </section>

      <section>
        <div class="section-heading">T4 slips</div>
        <div id="t4-slips">
          {% for slip in form_state.slips_t4 %}
            <div class="slip-wrapper t4-slip" data-slip-index="{{ slip.index }}">
              <div class="slip-header">
                <h4>T4 slip {{ loop.index }}</h4>
                <button type="button" class="btn danger remove-slip" {% if form_state.slips_t4|length == 1 %}disabled{% endif %}>Remove</button>
              </div>
              <div class="form-grid">
                <label class="field">
                  <span>Employment income</span>
                  <input inputmode="decimal" name="slips_t4-{{ slip.index }}-employment_income" value="{{ slip.employment_income }}" />
                  {% set key = 'slips_t4-' ~ slip.index ~ '-employment_income' %}
                  {% if field_errors.get(key) %}<div class="field-error">{{ field_errors.get(key) }}</div>{% endif %}
                </label>
                <label class="field">
                  <span>Tax deducted</span>
                  <input inputmode="decimal" name="slips_t4-{{ slip.index }}-tax_deducted" value="{{ slip.tax_deducted }}" />
                  {% set key = 'slips_t4-' ~ slip.index ~ '-tax_deducted' %}
                  {% if field_errors.get(key) %}<div class="field-error">{{ field_errors.get(key) }}</div>{% endif %}
                </label>
                <label class="field">
                  <span>CPP contributions</span>
                  <input inputmode="decimal" name="slips_t4-{{ slip.index }}-cpp_contrib" value="{{ slip.cpp_contrib }}" />
                </label>
                <label class="field">
                  <span>EI premiums</span>
                  <input inputmode="decimal" name="slips_t4-{{ slip.index }}-ei_premiums" value="{{ slip.ei_premiums }}" />
                </label>
                <label class="field">
                  <span>Pensionable earnings</span>
                  <input inputmode="decimal" name="slips_t4-{{ slip.index }}-pensionable_earnings" value="{{ slip.pensionable_earnings }}" />
                </label>
                <label class="field">
                  <span>Insurable earnings</span>
                  <input inputmode="decimal" name="slips_t4-{{ slip.index }}-insurable_earnings" value="{{ slip.insurable_earnings }}" />
                </label>
              </div>
            </div>
          {% endfor %}
        </div>
        <button type="button" id="add-slip" class="btn secondary">Add another T4 slip</button>
      </section>

      <section>
        <div class="section-heading">Return settings</div>
        <div class="form-grid">
          <label class="field">
            <span>Province of residence</span>
            <input name="province" maxlength="2" value="{{ form_state.province }}" />
            {% if field_errors.get('province') %}<div class="field-error">{{ field_errors.get('province') }}</div>{% endif %}
          </label>
          <label class="field">
            <span>Tax year</span>
            <input name="tax_year" inputmode="numeric" value="{{ form_state.tax_year }}" />
            {% if field_errors.get('tax_year') %}<div class="field-error">{{ field_errors.get('tax_year') }}</div>{% endif %}
            {% if supported_tax_years %}
              <div class="field-help">
                {% for year in supported_tax_years %}
                  {% set year_key = year|string %}
                  {% set info = efile_transmit_gate.get(year_key) %}
                  <div class="year-availability" data-tax-year="{{ year }}">
                    {{ year }} — {% if info and info.allowed %}Transmit enabled{% else %}<strong>Estimate only</strong>{% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </label>
          <label class="field">
            <span>RRSP contributions</span>
            <input inputmode="decimal" name="rrsp_contrib" value="{{ form_state.rrsp_contrib }}" />
          </label>
        </div>
      </section>

      <section>
        <div class="section-heading">T183 signature capture</div>
        <div class="form-grid">
          <label class="field">
            <span>Signature timestamp</span>
            <input type="datetime-local" name="t183_signed_ts" value="{{ form_state.t183.signed_ts }}" />
          </label>
          <label class="field">
            <span>IP hash</span>
            <input name="t183_ip_hash" value="{{ form_state.t183.ip_hash }}" />
          </label>
          <label class="field">
            <span>User-Agent hash</span>
            <input name="t183_user_agent_hash" value="{{ form_state.t183.user_agent_hash }}" />
          </label>
          <label class="field">
            <span>T183 PDF path</span>
            <input name="t183_pdf_path" value="{{ form_state.t183.pdf_path }}" />
          </label>
        </div>
      </section>

      <section>
        <div class="section-heading">Outputs</div>
        <div class="form-grid">
          <label class="field">
            <span>T1 PDF output path</span>
            <input name="out_path" value="{{ form_state.outputs.out_path }}" />
          </label>
        </div>
      </section>

      <section>
        <div class="section-heading">EFILE transmission overrides</div>
        <div class="form-grid">
          <label class="field">
            <span>Endpoint override</span>
            <input name="endpoint" value="{{ form_state.efile.endpoint }}" />
          </label>
          <label class="field">
            <span>Software ID</span>
            <input name="software_id" value="{{ form_state.efile.software_id }}" />
          </label>
          <label class="field">
            <span>Software version</span>
            <input name="software_ver" value="{{ form_state.efile.software_ver }}" />
          </label>
          <label class="field">
            <span>Transmitter ID</span>
            <input name="transmitter_id" value="{{ form_state.efile.transmitter_id }}" />
          </label>
        </div>
      </section>

      <div class="actions-row">
        <button type="submit" class="btn">Compute return</button>
        <a class="btn secondary" href="/ui/returns/new">Reset form</a>
      </div>
    </form>
  </div>

  <div class="card" id="prepare-results" {% if not calc and not payload_json and not issues %}hidden{% endif %}>
    <h2>Preparation results</h2>
    <div id="prepare-status-message" class="status-box {% if prepare_ok %}success{% elif issues %}warning{% endif %}">
      {% if prepare_ok %}
        <p>Return validated. Use the actions below to generate printouts or transmit electronically.</p>
      {% elif issues %}
        <p>Validation issues were reported. Resolve them before transmitting.</p>
      {% else %}
        <p>Complete the return form and choose “Compute return” to see results.</p>
      {% endif %}
    </div>
    <div id="prepare-issues" {% if not issues %}hidden{% endif %}>
      <ul class="messages">
        {% for issue in issues %}
          <li>{{ issue }}</li>
        {% endfor %}
      </ul>
    </div>
    {% if calc %}
      <div class="preview">
        <h3>Totals</h3>
        <table class="striped">
          <tbody id="calc-totals-body">
            {% for key, value in calc.totals.items() %}
              <tr><th>{{ key }}</th><td>{{ value }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <details open>
        <summary>Calculation details</summary>
        <pre id="calc-json">{{ calc_json }}</pre>
      </details>
    {% else %}
      <pre id="calc-json" hidden></pre>
    {% endif %}
    {% if payload_json %}
      <details>
        <summary>Submitted payload</summary>
        <pre id="payload-json">{{ payload_json }}</pre>
      </details>
    {% else %}
      <pre id="payload-json" hidden></pre>
    {% endif %}
    <div class="actions-row">
      <button type="button" id="print-button" class="btn">Render T1 PDF</button>
      <button type="button" id="efile-button" class="btn">Transmit via EFILE</button>
      <span
        id="efile-availability-note"
        class="status-note{% if not efile_selected_year_allowed %} warning{% endif %}"
        {% if efile_selected_year_allowed or not efile_selected_year_message %}hidden{% endif %}
      >{{ efile_selected_year_message }}</span>
    </div>
    <div id="print-status" class="status-box" hidden></div>
    <div id="efile-status" class="status-box" hidden></div>
    <section id="artifact-section" hidden>
      <h3>Generated artifacts</h3>
      <ul id="artifact-list" class="artifact-list"></ul>
    </section>
  </div>

  <template id="t4-slip-template">
    <div class="slip-wrapper t4-slip" data-slip-index="__index__">
      <div class="slip-header">
        <h4>T4 slip <span class="slip-number"></span></h4>
        <button type="button" class="btn danger remove-slip">Remove</button>
      </div>
      <div class="form-grid">
        <label class="field">
          <span>Employment income</span>
          <input inputmode="decimal" name="slips_t4-__index__-employment_income" />
        </label>
        <label class="field">
          <span>Tax deducted</span>
          <input inputmode="decimal" name="slips_t4-__index__-tax_deducted" />
        </label>
        <label class="field">
          <span>CPP contributions</span>
          <input inputmode="decimal" name="slips_t4-__index__-cpp_contrib" />
        </label>
        <label class="field">
          <span>EI premiums</span>
          <input inputmode="decimal" name="slips_t4-__index__-ei_premiums" />
        </label>
        <label class="field">
          <span>Pensionable earnings</span>
          <input inputmode="decimal" name="slips_t4-__index__-pensionable_earnings" />
        </label>
        <label class="field">
          <span>Insurable earnings</span>
          <input inputmode="decimal" name="slips_t4-__index__-insurable_earnings" />
        </label>
      </div>
    </div>
  </template>

  <script id="transmit-gate-data" type="application/json">{{ efile_transmit_gate | tojson }}</script>

  <script>
    const form = document.getElementById("return-form");
    const slipContainer = document.getElementById("t4-slips");
    const slipTemplate = document.getElementById("t4-slip-template");
    const prepareResults = document.getElementById("prepare-results");
    const prepareStatus = document.getElementById("prepare-status-message");
    const issuesBox = document.getElementById("prepare-issues");
    const calcTotalsBody = document.getElementById("calc-totals-body");
    const calcJson = document.getElementById("calc-json");
    const payloadJson = document.getElementById("payload-json");
    const printStatus = document.getElementById("print-status");
    const efileStatus = document.getElementById("efile-status");
    const artifactSection = document.getElementById("artifact-section");
    const artifactList = document.getElementById("artifact-list");
    const addSlipButton = document.getElementById("add-slip");
    const printButton = document.getElementById("print-button");
    const efileButton = document.getElementById("efile-button");
    const efileAvailabilityNote = document.getElementById("efile-availability-note");
    const transmitGateData = document.getElementById("transmit-gate-data");
    const taxYearField = form?.elements.namedItem("tax_year");

    let transmitGate = {};
    if (transmitGateData && transmitGateData.textContent) {
      try {
        transmitGate = JSON.parse(transmitGateData.textContent);
      } catch (err) {
        console.warn("Unable to parse transmit gate data", err);
      }
    }

    let nextSlipIndex = 0;
    document.querySelectorAll(".t4-slip").forEach((node) => {
      const idx = Number.parseInt(node.dataset.slipIndex || "0", 10);
      if (!Number.isNaN(idx) && idx >= nextSlipIndex) {
        nextSlipIndex = idx + 1;
      }
      const numberSpan = node.querySelector(".slip-number");
      if (numberSpan) {
        numberSpan.textContent = idx + 1;
      }
    });

    function setStatus(box, message, variant = "") {
      box.textContent = message;
      box.hidden = !message;
      box.classList.remove("success", "warning", "error");
      if (variant) {
        box.classList.add(variant);
      }
    }

    function transmitEntryForYear(yearValue) {
      const normalized = String(yearValue || "");
      if (Object.prototype.hasOwnProperty.call(transmitGate, normalized)) {
        return transmitGate[normalized];
      }
      return { allowed: false, message: "" };
    }

    function updateEfileAvailability() {
      if (!efileButton) return;
      const fallbackYear = Object.keys(transmitGate)[0] || "";
      const yearText = formValue("tax_year") || String(fallbackYear);
      const entry = transmitEntryForYear(yearText);
      const allowed = Boolean(entry?.allowed);
      efileButton.disabled = !allowed;
      if (efileAvailabilityNote) {
        const message = allowed ? "" : entry?.message || `${yearText} — Estimate only.`;
        efileAvailabilityNote.textContent = message;
        efileAvailabilityNote.hidden = !message;
        efileAvailabilityNote.classList.toggle("warning", !allowed && Boolean(message));
      }
      if (efileButton) {
        efileButton.title = allowed ? "" : entry?.message || "Transmission is disabled.";
      }
    }

    function toggleIssues(issues) {
      if (!issues || issues.length === 0) {
        issuesBox.hidden = true;
        issuesBox.innerHTML = "";
        return;
      }
      const list = document.createElement("ul");
      list.className = "messages";
      issues.forEach((issue) => {
        const item = document.createElement("li");
        item.textContent = issue;
        list.appendChild(item);
      });
      issuesBox.innerHTML = "";
      issuesBox.appendChild(list);
      issuesBox.hidden = false;
    }

    function addSlip(index) {
      const clone = slipTemplate.content.cloneNode(true);
      clone.querySelectorAll("[name]").forEach((input) => {
        const name = input.getAttribute("name");
        if (!name) return;
        input.setAttribute("name", name.replace(/__index__/g, String(index)));
      });
      const wrapper = clone.querySelector(".t4-slip");
      if (wrapper) {
        wrapper.dataset.slipIndex = String(index);
        const numberSpan = wrapper.querySelector(".slip-number");
        if (numberSpan) {
          numberSpan.textContent = index + 1;
        }
      }
      slipContainer.appendChild(clone);
      updateRemoveButtons();
    }

    function updateRemoveButtons() {
      const slips = slipContainer.querySelectorAll(".t4-slip");
      const disable = slips.length === 1;
      slips.forEach((wrapper) => {
        const button = wrapper.querySelector(".remove-slip");
        if (button) {
          button.disabled = disable;
        }
        const numberSpan = wrapper.querySelector(".slip-number");
        if (numberSpan) {
          const idx = Number.parseInt(wrapper.dataset.slipIndex || "0", 10);
          numberSpan.textContent = idx + 1;
        }
      });
    }

    addSlipButton?.addEventListener("click", () => {
      addSlip(nextSlipIndex++);
    });

    slipContainer.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      if (!target.classList.contains("remove-slip")) return;
      const wrapper = target.closest(".t4-slip");
      if (!wrapper) return;
      if (slipContainer.querySelectorAll(".t4-slip").length === 1) return;
      wrapper.remove();
      updateRemoveButtons();
    });

    function formValue(name) {
      const field = form.elements.namedItem(name);
      if (!field) return "";
      return String(field.value || "").trim();
    }

    function dependantsFromText(raw) {
      if (!raw) return [];
      return raw
        .split(/\r?\n|,/)
        .map((item) => item.trim())
        .filter(Boolean);
    }

    function gatherSlips() {
      const slips = [];
      form.querySelectorAll(".t4-slip").forEach((wrapper) => {
        const index = wrapper.dataset.slipIndex;
        if (!index) return;
        const payload = {
          employment_income: formValue(`slips_t4-${index}-employment_income`),
          tax_deducted: formValue(`slips_t4-${index}-tax_deducted`),
          cpp_contrib: formValue(`slips_t4-${index}-cpp_contrib`),
          ei_premiums: formValue(`slips_t4-${index}-ei_premiums`),
          pensionable_earnings: formValue(`slips_t4-${index}-pensionable_earnings`),
          insurable_earnings: formValue(`slips_t4-${index}-insurable_earnings`),
        };
        if (Object.values(payload).some((value) => value !== "")) {
          slips.push(payload);
        }
      });
      return slips;
    }

    function normalizeTimestamp(value) {
      if (!value) return null;
      if (value.length === 16) {
        return `${value}:00`;
      }
      return value;
    }

    function buildPayload() {
      const province = formValue("province") || formValue("taxpayer_province") || "ON";
      const payload = {
        taxpayer: {
          sin: formValue("taxpayer_sin"),
          first_name: formValue("taxpayer_first_name"),
          last_name: formValue("taxpayer_last_name"),
          dob: formValue("taxpayer_dob"),
          address_line1: formValue("taxpayer_address_line1"),
          city: formValue("taxpayer_city"),
          province,
          postal_code: formValue("taxpayer_postal_code"),
          residency_status: formValue("taxpayer_residency_status") || "resident",
        },
        household: {
          marital_status: formValue("household_marital_status") || "single",
          spouse_sin: formValue("household_spouse_sin") || null,
          dependants: dependantsFromText(formValue("household_dependants_raw")),
        },
        slips_t4: gatherSlips(),
        rrsp_contrib: formValue("rrsp_contrib") || "0",
        province,
        tax_year: formValue("tax_year") || "2025",
        t183_signed_ts: normalizeTimestamp(formValue("t183_signed_ts")),
        t183_ip_hash: formValue("t183_ip_hash") || null,
        t183_user_agent_hash: formValue("t183_user_agent_hash") || null,
        t183_pdf_path: formValue("t183_pdf_path") || null,
      };
      return payload;
    }

    function updateCalcTables(calc) {
      if (!calcTotalsBody) return;
      if (!calc || !calc.totals) {
        calcTotalsBody.innerHTML = "";
        return;
      }
      calcTotalsBody.innerHTML = "";
      Object.entries(calc.totals).forEach(([key, value]) => {
        const row = document.createElement("tr");
        const keyCell = document.createElement("th");
        keyCell.textContent = key;
        const valueCell = document.createElement("td");
        valueCell.textContent = value;
        row.appendChild(keyCell);
        row.appendChild(valueCell);
        calcTotalsBody.appendChild(row);
      });
    }

    function showArtifacts(items) {
      artifactList.innerHTML = "";
      if (!items || items.length === 0) {
        artifactSection.hidden = true;
        return;
      }
      items.forEach((item) => {
        const li = document.createElement("li");
        const link = document.createElement("a");
        link.href = `/ui/artifacts/download?path=${encodeURIComponent(item.path)}`;
        link.target = "_blank";
        link.rel = "noopener";
        link.textContent = item.label || item.path;
        li.appendChild(link);
        artifactList.appendChild(li);
      });
      artifactSection.hidden = false;
    }

    async function fetchArtifacts(digest) {
      try {
        const response = await fetch(`/ui/artifacts/list?digest=${encodeURIComponent(digest)}`);
        if (!response.ok) return;
        const data = await response.json();
        showArtifacts(data.paths || []);
      } catch (err) {
        console.error("Unable to load artifacts", err);
      }
    }

    async function handlePrepare(event) {
      event.preventDefault();
      const payload = buildPayload();
      updateEfileAvailability();
      setStatus(prepareStatus, "Computing return…");
      toggleIssues([]);
      prepareResults.hidden = false;
      try {
        const response = await fetch("/prepare", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        payloadJson.textContent = JSON.stringify(payload, null, 2);
        payloadJson.hidden = false;
        if (!response.ok) {
          setStatus(prepareStatus, data.detail || "Failed to compute return", "error");
          updateCalcTables(null);
          calcJson.hidden = true;
          return;
        }
        if (!data.ok) {
          setStatus(prepareStatus, "Validation errors detected.", "warning");
          toggleIssues(data.issues || []);
          updateCalcTables(null);
          calcJson.hidden = true;
          return;
        }
        setStatus(prepareStatus, "Return validated. Ready for print or transmission.", "success");
        toggleIssues([]);
        updateCalcTables(data.calc);
        calcJson.textContent = JSON.stringify(data.calc, null, 2);
        calcJson.hidden = false;
      } catch (error) {
        console.error(error);
        setStatus(prepareStatus, "Unexpected error computing return.", "error");
      }
    }

    async function handlePrint() {
      const payload = buildPayload();
      const outPath = formValue("out_path") || "artifacts/printouts/t1.pdf";
      setStatus(printStatus, "Rendering PDF…");
      try {
        const response = await fetch("/printout/t1", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...payload, out_path: outPath }),
        });
        const data = await response.json();
        if (!response.ok) {
          setStatus(printStatus, data.detail || "Unable to render PDF", "error");
          return;
        }
        setStatus(printStatus, `PDF saved to ${data.pdf}`, "success");
        showArtifacts([{ path: data.pdf, label: data.pdf }]);
      } catch (error) {
        console.error(error);
        setStatus(printStatus, "Unexpected error while rendering PDF", "error");
      }
    }

    async function handleEfile() {
      const payload = buildPayload();
      const endpoint = formValue("endpoint");
      const softwareId = formValue("software_id");
      const softwareVer = formValue("software_ver");
      const transmitterId = formValue("transmitter_id");
      const requestPayload = {
        ...payload,
        endpoint: endpoint || null,
        software_id: softwareId || null,
        software_ver: softwareVer || null,
        transmitter_id: transmitterId || null,
      };
      const taxYearEntry = transmitEntryForYear(payload.tax_year);
      if (!taxYearEntry.allowed) {
        const detail = taxYearEntry.message || `${payload.tax_year} — Estimate only. Transmission is disabled.`;
        setStatus(efileStatus, detail, "warning");
        updateEfileAvailability();
        return;
      }
      setStatus(efileStatus, "Preparing EFILE submission…");
      try {
        const response = await fetch("/prepare/efile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestPayload),
        });
        const data = await response.json();
        if (!response.ok) {
          const detail = Array.isArray(data.detail)
            ? data.detail.map((issue) => issue.message || JSON.stringify(issue)).join("; ")
            : data.detail;
          setStatus(efileStatus, detail || "EFILE submission failed", "error");
          return;
        }
        const summary = [`Digest ${data.digest}`, `Reference ${data.sbmt_ref_id}`].join(" — ");
        setStatus(efileStatus, summary, "success");
        fetchArtifacts(data.digest);
      } catch (error) {
        console.error(error);
        setStatus(efileStatus, "Unexpected error during EFILE transmission", "error");
      }
    }

    if (form) {
      form.addEventListener("submit", handlePrepare);
    }
    printButton?.addEventListener("click", handlePrint);
    efileButton?.addEventListener("click", handleEfile);
    taxYearField?.addEventListener("input", updateEfileAvailability);
    taxYearField?.addEventListener("change", updateEfileAvailability);
    updateRemoveButtons();
    updateEfileAvailability();
  </script>
{% endblock %}
